var u={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"};function M({canvas:h}){let a=h.getContext("2d"),f=50,m=Symbol("original"),w=Symbol("clone"),x=i=>typeof i=="object"&&!Array.isArray(i)&&i!==null,S=function(i){return i[m]??i},y=function(i){return i[w]??i},d=async(i,c,p=0)=>{if(c.has(i))return c.get(i);if(i[m]||i.type==="document")return i;let I={};if(c.set(i,I),I[m]=i,i[w]=I,f<=p+1)throw console.error("We've reach limit depth!",i),new Error("limit reached");for(let D of Object.keys(i)){let r=await b(i[D],i);x(r)?r=await d(r,c,p+1):Array.isArray(r)&&(r=await l(r,c,p+1)),I[D]=r}return I},l=async(i,c,p=0)=>{let I=[];if(f<=p+1)throw console.error("We've reach limit depth!",i),new Error("limit reached");for(let D of i){let r=await b(D,i);x(r)?r=await d(r,c,p+1):Array.isArray(r)&&(r=await l(r,c,p+1)),I.push(r)}return I},b=async(i,c)=>typeof i=="function"?await i(a,c):i;return{isClone:i=>!!i[m],cloneDefinition:async i=>await d(i,new WeakMap),getClone:y,getOriginal:S}}function j(h){let{herald:a}=h,f=[],m=[],w=Symbol("layer"),{cloneDefinition:x,isClone:S,getOriginal:y,getClone:d}=M(h),l={type:"document",base:[],layout:[],start:{x:0,y:0},size:{w:0,h:0},settings:{core:{fonts:[]}}};console.log(l);let b=(e,n=100)=>{let t;return(...o)=>{clearTimeout(t),o[0]!=="clear"&&(t=setTimeout(()=>{e.apply({},o)},n))}},L=b(()=>{a.dispatch(new CustomEvent(u.RECALC_FINISHED))}),E=b(async()=>{m.length!=0&&(await m.shift()(),E())}),i=e=>{a.dispatchSync(new CustomEvent(u.DRAW,{detail:{element:e}}))},c=(e=l.layout)=>{for(let n of e)i(n)},p=(e,n,t)=>{e.hierarchy??={parent:n,position:t},n&&(e.hierarchy.parent=n),t&&(e.hierarchy.position=t)},I=e=>{let n=!1,t=s=>{setTimeout(()=>{if(!n){t(s);return}e().then(g=>{s(g)})})},o=new Promise(s=>{t(s)});return m.push(()=>(n=!0,o)),E(),o},D=async(e,n=null,t=null,o=null)=>{if(o!==(f[0]??null))return I(()=>D(e,n,t,o));let s=y(e);t??=s.hierarchy?.position??0,p(s,n?y(n):null,t);let g=new CustomEvent(u.CALC,{detail:{element:e,sessionId:o}});await a.dispatch(g);let F=g.detail.element;return T(F),p(F,n?d(n):null,t),F},r=()=>Math.random().toString(16).slice(2),z=e=>d(e)[w]===!0,T=e=>{e[w]=!0,y(e).id??=r();let n=d(e);return n.id||Object.defineProperty(n,"id",{get(){return y(e).id}}),e},G=()=>{let e=Symbol("illustrator_session_id"+String(Math.random()));return f.push(e),e},W=()=>{f.shift()},_=async(e=l,n=l.base,t=null)=>{let o=t??G();T(e);let s=[];for(let g=0;g<n.length;g++)s.push(await D(n[g],e,g,o));return e.layout=s,L(),t||W(),s},k=async e=>{if(!e.hierarchy?.parent)return;let n=e.hierarchy.position,t=e.hierarchy.parent;d(t).layout[n]=await D(e,t,n)},Q=async(e,n)=>{e.start=n,await k(e)},Y=async(e,n)=>{e.size=n,await k(e)},X=(e,n=null,t=null)=>{n&&S(n)&&(n=y(n));let o=n?n.layout:l.base;n??=l,n.base&&(o=n.base),t??=o.length,A(e,n,t,o)},q=(e,n=null,t=null)=>{n&&!S(n)&&(n=d(n)),n??=l,t??=n.layout.length,A(e,n,t,n.layout)},A=(e,n,t,o)=>{o.splice(t,0,e),e.hierarchy={position:t,parent:n},P(o)},P=e=>{for(let n=0;n<e.length;n++){let t=e[n];t.hierarchy&&(t.hierarchy.position=n)}},K=e=>{if(!e.hierarchy?.parent)return;let n=e.hierarchy.position,t=y(e.hierarchy.parent),o=(t?.type==="document"?t.base:t?.layout)??[];o[n]===y(e)&&(o.splice(n,1),P(o))},J=e=>{if(!e.hierarchy?.parent)return;let n=e.hierarchy.position,o=d(e.hierarchy.parent).layout;o[n]===d(e)&&(o.splice(n,1),P(o))},U=async e=>{try{let n=new FontFace(e.name,"url("+e.url+")"),t=document.fonts.add(await n.load());return v.view.redrawDebounce(),t}catch(n){return console.error("Font couldn't be loaded:",e.name+",",e.url,n),null}},Z=async()=>{document.fonts.clear();let e=[];for(let n of l.settings?.core?.fonts??[])e.push(U(n));return Promise.all(e)},$=async function(e={}){let n=new CustomEvent(u.SETTINGS,{detail:{settings:[],additional:e}});return await a.dispatch(n),n.detail.settings},O=(e,n,t)=>{if(e.length<=1){t[e[0]]=n;return}if(t[e[0]]??={},typeof t[e[0]]!="object"||t[e[0]]===null){console.warn("Cannot set setting, due to one of destination not being an object",e,t,n);return}O(e.slice(1),n,t[e[0]])},N=(e,n)=>{if(e.length<=1)return n[e[0]];if(n[e[0]])return N(e.slice(1),n[e[0]])},ee=e=>{let n=e.detail.settings,t=()=>{let o=[];for(let s of l.settings?.core?.fonts??[])o.push([[{type:"asset",name:"url",label:"File",value:s.url},{type:"title",name:"name",label:"Name",value:s.name}]]);return o};n.push({details:{label:"Core"},name:"core",tabs:[{label:"Font",fields:[[{label:"Fonts",type:"container",fields:[[{name:"fonts",type:"list",label:"Fonts List",template:[[{type:"asset",name:"url",label:"File",value:""},{type:"title",name:"name",label:"Name",value:""}]],entry:{url:"",name:""},fields:t()}]]}]]}]})},ne=()=>{let e=new CustomEvent(u.TYPE_DEFINITION,{detail:{definitions:{}}});return a.dispatchSync(e),e.detail.definitions},v={meta:{document:l,generateId:r,layerDefinitions:ne},clone:{definitions:x,getOriginal:y,getClone:d},manage:{markAsLayer:T,remove:K,removeVolatile:J,add:X,addVolatile:q,calcAndUpdateLayer:k},view:{calc:D,recalculate:_,draw:i,redraw:c,redrawDebounce:b(c),move:Q,resize:Y},policies:{isLayer:z,isClone:S},font:{load:U,reload:Z},setting:{set(e,n){let t=e.split(".");t.slice(-1)||t.pop(),O(t,n,l.settings)},get(e){let n=e.split(".");return n.slice(-1)||n.pop(),N(n,l.settings)??null},has:function(e){return!!(this.get(e)??!1)},retrieve:$}},R=e=>!!(e&&typeof e=="object"&&!Array.isArray(e)),C=(e,...n)=>{if(!n.length)return e;let t=n.shift();if(R(e)&&R(t))for(let o in t){let s=t[o];R(s)?(e[o]||Object.assign(e,{[o]:{}}),C(e[o],s)):Object.assign(e,{[o]:s})}return C(e,...n)},te=async(e,n)=>{for(let o in n)v.setting.set(o,n[o]);let t=l;return t.settings=C({},t.settings,n),t.base=e,Promise.all((v.setting.get("core.fonts")??[]).map(o=>v.font.load(o))).then(()=>{a.dispatch(new CustomEvent(u.FONTS_LOADED))}),t.layout=await v.view.recalculate(t,t.base),v.view.redraw(t.layout),t},oe=a.batch([{event:u.CLOSE,subscription:()=>{oe()}},{event:u.INIT,subscription:e=>{let{base:n,settings:t}=e.detail;return te(n,t)}},{event:u.SETTINGS,subscription:e=>{ee(e)}},{event:u.CALC,subscription:[{priority:-255,method:async e=>{e.detail.element!==null&&(e.detail.element=await v.clone.definitions(e.detail.element))}}]}]);return v}var H="core",V="0.0.5",B=class{#e;#n=null;#t=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(a){this.#e=a}async loadModules(a,f){return(await this.#i()).loadModules(a,f)}register(a){let{registration:f}=a.detail;f[H]={load:async()=>(this.#n??=(await this.#o("core.js")).default,(m,w)=>this.#n({canvas:w,modules:m,herald:this.#e.herald})),version:V}}static subscriptions={[u.MODULES]:"register"};#o(a){return import(this.#e.marshal.getResourceUrl(this,a))}async#i(){return this.#t??=(await this.#o("helper.js")).default,new this.#t(this.#e.herald)}};export{B as AntetypeCore,j as Core,u as Event,H as ID,V as VERSION};
