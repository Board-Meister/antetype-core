var l={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded",CANVAS_CHANGE:"antetype.canvas.change"};var k=Symbol("original"),$=Symbol("clone");function U(S){let g=i=>typeof i=="object"&&!Array.isArray(i)&&i!==null,y=function(i){return i[k]??i},c=function(i){return i[$]??i},h=async(i,u,a=0)=>{if(u.has(i))return u.get(i);if(i[k]||i.type==="document")return i;let m={};if(u.set(i,m),m[k]=i,i[$]=m,50<=a+1)throw console.error("We've reach limit depth!",i),new Error("limit reached");for(let w of Object.keys(i)){let s=await C(i[w],i);g(s)?s=await h(s,u,a+1):Array.isArray(s)&&(s=await b(s,u,a+1)),m[w]=s}return m},b=async(i,u,a=0)=>{let m=[];if(50<=a+1)throw console.error("We've reach limit depth!",i),new Error("limit reached");for(let w of i){let s=await C(w,i);g(s)?s=await h(s,u,a+1):Array.isArray(s)&&(s=await b(s,u,a+1)),m.push(s)}return m},C=async(i,u)=>typeof i=="function"?await i(S()?.getContext("2d"),u):i;return{isClone:i=>!!i[k],cloneDefinition:async i=>await h(i,new WeakMap),getClone:c,getOriginal:y}}var ee=Symbol("layer");function ne(S){let{herald:f}=S,g=[],y=[],c=null,h=new WeakMap,b=null,C=()=>c,{cloneDefinition:H,isClone:P,getOriginal:i,getClone:u}=U(C),a={type:"document",base:[],layout:[],start:{x:0,y:0},size:{w:0,h:0},settings:{core:{fonts:[]}}};console.log(a);let m=(e,n=100)=>{let t;return(...o)=>{clearTimeout(t),o[0]!=="clear"&&(t=setTimeout(()=>{e.apply({},o)},n))}},w=(e,n=100)=>{let t,o,r,d=new Promise(I=>{r=I});return async(...I)=>(clearTimeout(t),o&&o(),I[0]==="clear"?(r(void 0),d):(await new Promise((v,D)=>{t=setTimeout(()=>{v(!0)},n),o=D}).catch(()=>!1)&&e.apply({},I).then(v=>{r(v),d=new Promise(D=>{r=D})}),d))},s=(e,n={})=>f.dispatch(e,{origin:c,...n}),T=(e,n={})=>{f.dispatchSync(e,{origin:c,...n})},ie=m(()=>{s(new CustomEvent(l.RECALC_FINISHED))}),j=m(async()=>{y.length!=0&&(await y.shift()(),j())}),z=e=>{T(new CustomEvent(l.DRAW,{detail:{element:e}}))},G=(e=a.layout)=>{for(let n of e)z(n)},W=(e,n,t)=>{e.hierarchy??={parent:n,position:t},n&&(e.hierarchy.parent=n),t&&(e.hierarchy.position=t)},re=e=>{let n=!1,t=r=>{setTimeout(()=>{if(!n){t(r);return}e().then(d=>{r(d)})})},o=new Promise(r=>{t(r)});return y.push(()=>(n=!0,o)),j(),o},R=async(e,n=null,t=null,o=null)=>{if(o!==(g[0]??null))return re(()=>R(e,n,t,o));let r=i(e);t??=r.hierarchy?.position??0,W(r,n?i(n):null,t);let d=new CustomEvent(l.CALC,{detail:{element:e,sessionId:o}});await s(d);let I=d.detail.element;return F(I),W(I,n?u(n):null,t),I},_=()=>Math.random().toString(16).slice(2),se=e=>u(e)[ee]===!0,F=e=>{e[ee]=!0,i(e).id??=_();let n=u(e);return n.id||Object.defineProperty(n,"id",{get(){return i(e).id}}),e},ae=()=>{let e=Symbol("illustrator_session_id"+String(Math.random()));return g.push(e),e},le=()=>{g.shift()},Q=async(e=a,n=a.base,t=null)=>{let o=t??ae();F(e);let r=[];for(let d=0;d<n.length;d++)r.push(await R(n[d],e,d,o));return e.layout=r,ie(),t||le(),r},M=async e=>{if(!e.hierarchy?.parent)return;let n=e.hierarchy.position,t=e.hierarchy.parent;u(t).layout[n]=await R(e,t,n)},ce=async(e,n)=>{e.start=n,await M(e)},ue=async(e,n)=>{e.size=n,await M(e)},de=(e,n=null,t=null)=>{n&&P(n)&&(n=i(n));let o=n?n.layout:a.base;n??=a,n.base&&(o=n.base),t??=o.length,Y(e,n,t,o)},fe=(e,n=null,t=null)=>{n&&!P(n)&&(n=u(n)),n??=a,t??=n.layout.length,Y(e,n,t,n.layout)},Y=(e,n,t,o)=>{o.splice(t,0,e),e.hierarchy={position:t,parent:n},B(o)},B=e=>{for(let n=0;n<e.length;n++){let t=e[n];t.hierarchy&&(t.hierarchy.position=n)}},me=e=>{if(!e.hierarchy?.parent)return;let n=e.hierarchy.position,t=i(e.hierarchy.parent),o=(t?.type==="document"?t.base:t?.layout)??[],r=i(e);o[n]===r&&(o.splice(n,1),h.delete(r),B(o))},pe=e=>{if(!e.hierarchy?.parent)return;let n=e.hierarchy.position,o=u(e.hierarchy.parent).layout;o[n]===u(e)&&(o.splice(n,1),B(o))},E=new WeakMap,q=async e=>{if(E.has(e))return console.warn("Already loaded or loading "+e.name+" "),E.get(e);try{E.set(e,null);let n=new FontFace(e.name,"url("+e.url+")"),t=document.fonts.add(await n.load());return E.set(e,t),p.view.redrawDebounce(),t}catch(n){return E.set(e,null),console.error("Font couldn't be loaded:",e.name+",",e.url,n),null}},ye=async()=>{document.fonts.clear();let e=[];for(let n of a.settings?.core?.fonts??[])e.push(q(n));return Promise.all(e)},Ie=async function(e={}){let n=new CustomEvent(l.SETTINGS,{detail:{settings:[],additional:e}});return await s(n),n.detail.settings},K=(e,n,t)=>{if(e.length<=1){t[e[0]]=n;return}if(t[e[0]]??={},typeof t[e[0]]!="object"||t[e[0]]===null){console.warn("Cannot set setting, due to one of destination not being an object",e,t,n);return}K(e.slice(1),n,t[e[0]])},X=(e,n)=>{if(e.length<=1)return n[e[0]];if(n[e[0]])return X(e.slice(1),n[e[0]])},J=e=>{let n=e.detail.settings,t=()=>{let o=[];for(let r of a.settings?.core?.fonts??[])o.push([[{type:"asset",name:"url",label:"File",value:r.url},{type:"title",name:"name",label:"Name",value:r.name}]]);return o};n.push({details:{label:"Core"},name:"core",tabs:[{label:"Font",fields:[[{label:"Fonts",type:"container",fields:[[{name:"fonts",type:"list",label:"Fonts List",template:[[{type:"asset",name:"url",label:"File",value:""},{type:"title",name:"name",label:"Name",value:""}]],entry:{url:"",name:""},fields:t()}]]}]]}]})},ge=()=>{let e=new CustomEvent(l.TYPE_DEFINITION,{detail:{definitions:{}}});return T(e),e.detail.definitions},ve=async e=>{if(e===null||!(e instanceof HTMLCanvasElement)&&!(e instanceof OffscreenCanvas))throw new Error("Invalid value, not an empty or Canvas like");if(c==e)return;let n=new CustomEvent(l.CANVAS_CHANGE,{detail:{current:e,previous:c}});await s(n),c=n.detail.current,we()},De=(e,n)=>(typeof e.subscription=="function"||typeof e.subscription=="string"?e.anchor=n:Array.isArray(e.subscription)?e.subscription.forEach(t=>{t.anchor=n}):e.subscription.anchor=n,e),L=(e,n=null,t={unregister:null})=>(n??=p.meta.getCanvas(),t.unregister=f.batch([{event:l.CLOSE,subscription:()=>{t.unregister()},anchor:n},{event:l.CANVAS_CHANGE,subscription:({detail:{current:o}})=>{t.unregister(),L(e,o,t)},anchor:n},...e.reduce((o,r)=>[...o,De(r,n)],[])]),()=>{t.unregister()}),he=(e,n,t,o,r)=>{let d=e.getTransform(),N=[new DOMPoint(n,t),new DOMPoint(n+o,t),new DOMPoint(n,t+r),new DOMPoint(n+o,t+r)].map(x=>d.transformPoint(x)),v=N.map(x=>x.x),D=N.map(x=>x.y);return{width:o,height:r,left:Math.min(...v),right:Math.max(...v),top:Math.min(...D),bottom:Math.max(...D),x:(Math.min(...v)+Math.max(...v))/2,y:(Math.min(...D)+Math.max(...D))/2}},be=()=>({event:{batch:L,dispatch:s,dispatchSync:T},meta:{document:a,generateId:_,layerDefinitions:ge,getCanvas:C,setCanvas:ve},clone:{definitions:H,getOriginal:i,getClone:u},manage:{markAsLayer:F,remove:me,removeVolatile:pe,add:de,addVolatile:fe,calcAndUpdateLayer:M},view:{calc:R,recalculate:Q,draw:z,redraw:G,redrawDebounce:m(G),recalculateDebounce:w(Q),move:ce,resize:ue,getBoundingBox:e=>h.get(e)??null},policies:{isLayer:se,isClone:P},font:{load:q,reload:ye},setting:{set(e,n){let t=e.split(".");t.slice(-1)||t.pop(),K(t,n,a.settings)},get(e){let n=e.split(".");return n.slice(-1)||n.pop(),X(n,a.settings)??null},has:function(e){return!!(this.get(e)??!1)},retrieve:Ie}}),A=e=>!!(e&&typeof e=="object"&&!Array.isArray(e)),O=(e,...n)=>{if(!n.length)return e;let t=n.shift();if(A(e)&&A(t))for(let o in t){let r=t[o];A(r)?(e[o]||Object.assign(e,{[o]:{}}),O(e[o],r)):Object.assign(e,{[o]:r})}return O(e,...n)},Z=async(e,n)=>{for(let o in n)p.setting.set(o,n[o]);let t=a;return t.settings=O({},t.settings,n),t.base=e,Promise.all((p.setting.get("core.fonts")??[]).map(o=>p.font.load(o))).then(()=>{s(new CustomEvent(l.FONTS_LOADED))}),t.layout=await p.view.recalculate(t,t.base),p.view.redraw(t.layout),t},we=()=>{b&&b(),b=f.batch([{event:l.CLOSE,subscription:()=>{b()},anchor:c},{event:l.INIT,subscription:e=>{let{base:n,settings:t}=e.detail;return Z(n,t)},anchor:c},{event:l.SETTINGS,subscription:e=>{J(e)},anchor:c},{event:l.CALC,subscription:[{priority:-255,method:async e=>{e.detail.element!==null&&(e.detail.element=await p.clone.definitions(e.detail.element))}}],anchor:c}])},p=be();return L([{event:l.INIT,subscription:e=>{let{base:n,settings:t}=e.detail;return Z(n,t)},anchor:c},{event:l.SETTINGS,subscription:e=>{J(e)},anchor:c},{event:l.CALC,subscription:[{priority:-255,method:async e=>{e.detail.element!==null&&(e.detail.element=await p.clone.definitions(e.detail.element))}}],anchor:c},{event:l.DRAW,subscription:({detail:{element:e}})=>{if(!c||!e.area)return;let n=c.getContext("2d");h.set(i(e),he(n,e.area.start.x,e.area.start.y,e.area.size.w,e.area.size.h))}}]),p}var te="core",oe="0.0.5",V=class{#n;#t=null;#e=!1;#o=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(f){this.#n=f}async loadModules(f){return(await this.#r()).loadModules(f)}register(f){let{registration:g}=f.detail;g[te]={load:async()=>(!this.#t&&!this.#e&&(this.#e=new Promise(y=>{this.#i("core.js").then(c=>{this.#t=c.default,this.#e=!1,y()})})),this.#e&&await this.#e,y=>this.#t({modules:y,herald:this.#n.herald})),version:oe}}static subscriptions={[l.MODULES]:"register"};#i(f){return import(this.#n.marshal.getResourceUrl(this,f))}async#r(){return this.#o??=(await this.#i("helper.js")).default,new this.#o(this.#n.herald)}};export{V as AntetypeCore,ne as Core,l as Event,te as ID,oe as VERSION};
