var u={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded",CANVAS_CHANGE:"antetype.canvas.change"};var x=Symbol("original"),Y=Symbol("clone");function L(b){let g=i=>typeof i=="object"&&!Array.isArray(i)&&i!==null,p=function(i){return i[x]??i},c=function(i){return i[Y]??i},v=async(i,r,f=0)=>{if(r.has(i))return r.get(i);if(i[x]||i.type==="document")return i;let m={};if(r.set(i,m),m[x]=i,i[Y]=m,50<=f+1)throw console.error("We've reach limit depth!",i),new Error("limit reached");for(let y of Object.keys(i)){let a=await C(i[y],i);g(a)?a=await v(a,r,f+1):Array.isArray(a)&&(a=await w(a,r,f+1)),m[y]=a}return m},w=async(i,r,f=0)=>{let m=[];if(50<=f+1)throw console.error("We've reach limit depth!",i),new Error("limit reached");for(let y of i){let a=await C(y,i);g(a)?a=await v(a,r,f+1):Array.isArray(a)&&(a=await w(a,r,f+1)),m.push(a)}return m},C=async(i,r)=>typeof i=="function"?await i(b()?.getContext("2d"),r):i;return{isClone:i=>!!i[x],cloneDefinition:async i=>await v(i,new WeakMap),getClone:c,getOriginal:p}}var X=Symbol("layer");function q(b){let{herald:d}=b,g=[],p=[],c=null,v=null,w=()=>c,{cloneDefinition:C,isClone:S,getOriginal:I,getClone:i}=L(w),r={type:"document",base:[],layout:[],start:{x:0,y:0},size:{w:0,h:0},settings:{core:{fonts:[]}}};console.log(r);let f=(e,n=100)=>{let t;return(...o)=>{clearTimeout(t),o[0]!=="clear"&&(t=setTimeout(()=>{e.apply({},o)},n))}},m=(e,n=100)=>{let t,o,s,l=new Promise(h=>{s=h});return async(...h)=>(clearTimeout(t),o&&o(),h[0]==="clear"?(s(void 0),l):(await new Promise((M,B)=>{t=setTimeout(()=>{M(!0)},n),o=B}).catch(()=>!1)&&e.apply({},h).then(M=>{s(M),l=new Promise(B=>{s=B})}),l))},y=(e,n={})=>d.dispatch(e,{origin:c,...n}),a=(e,n={})=>{d.dispatchSync(e,{origin:c,...n})},Z=f(()=>{y(new CustomEvent(u.RECALC_FINISHED))}),O=f(async()=>{p.length!=0&&(await p.shift()(),O())}),U=e=>{a(new CustomEvent(u.DRAW,{detail:{element:e}}))},N=(e=r.layout)=>{for(let n of e)U(n)},V=(e,n,t)=>{e.hierarchy??={parent:n,position:t},n&&(e.hierarchy.parent=n),t&&(e.hierarchy.position=t)},$=e=>{let n=!1,t=s=>{setTimeout(()=>{if(!n){t(s);return}e().then(l=>{s(l)})})},o=new Promise(s=>{t(s)});return p.push(()=>(n=!0,o)),O(),o},E=async(e,n=null,t=null,o=null)=>{if(o!==(g[0]??null))return $(()=>E(e,n,t,o));let s=I(e);t??=s.hierarchy?.position??0,V(s,n?I(n):null,t);let l=new CustomEvent(u.CALC,{detail:{element:e,sessionId:o}});await y(l);let h=l.detail.element;return P(h),V(h,n?i(n):null,t),h},j=()=>Math.random().toString(16).slice(2),ee=e=>i(e)[X]===!0,P=e=>{e[X]=!0,I(e).id??=j();let n=i(e);return n.id||Object.defineProperty(n,"id",{get(){return I(e).id}}),e},ne=()=>{let e=Symbol("illustrator_session_id"+String(Math.random()));return g.push(e),e},te=()=>{g.shift()},H=async(e=r,n=r.base,t=null)=>{let o=t??ne();P(e);let s=[];for(let l=0;l<n.length;l++)s.push(await E(n[l],e,l,o));return e.layout=s,Z(),t||te(),s},k=async e=>{if(!e.hierarchy?.parent)return;let n=e.hierarchy.position,t=e.hierarchy.parent;i(t).layout[n]=await E(e,t,n)},oe=async(e,n)=>{e.start=n,await k(e)},ie=async(e,n)=>{e.size=n,await k(e)},re=(e,n=null,t=null)=>{n&&S(n)&&(n=I(n));let o=n?n.layout:r.base;n??=r,n.base&&(o=n.base),t??=o.length,z(e,n,t,o)},se=(e,n=null,t=null)=>{n&&!S(n)&&(n=i(n)),n??=r,t??=n.layout.length,z(e,n,t,n.layout)},z=(e,n,t,o)=>{o.splice(t,0,e),e.hierarchy={position:t,parent:n},T(o)},T=e=>{for(let n=0;n<e.length;n++){let t=e[n];t.hierarchy&&(t.hierarchy.position=n)}},ae=e=>{if(!e.hierarchy?.parent)return;let n=e.hierarchy.position,t=I(e.hierarchy.parent),o=(t?.type==="document"?t.base:t?.layout)??[];o[n]===I(e)&&(o.splice(n,1),T(o))},le=e=>{if(!e.hierarchy?.parent)return;let n=e.hierarchy.position,o=i(e.hierarchy.parent).layout;o[n]===i(e)&&(o.splice(n,1),T(o))},G=async e=>{try{let n=new FontFace(e.name,"url("+e.url+")"),t=document.fonts.add(await n.load());return D.view.redrawDebounce(),t}catch(n){return console.error("Font couldn't be loaded:",e.name+",",e.url,n),null}},ce=async()=>{document.fonts.clear();let e=[];for(let n of r.settings?.core?.fonts??[])e.push(G(n));return Promise.all(e)},ue=async function(e={}){let n=new CustomEvent(u.SETTINGS,{detail:{settings:[],additional:e}});return await y(n),n.detail.settings},_=(e,n,t)=>{if(e.length<=1){t[e[0]]=n;return}if(t[e[0]]??={},typeof t[e[0]]!="object"||t[e[0]]===null){console.warn("Cannot set setting, due to one of destination not being an object",e,t,n);return}_(e.slice(1),n,t[e[0]])},W=(e,n)=>{if(e.length<=1)return n[e[0]];if(n[e[0]])return W(e.slice(1),n[e[0]])},de=e=>{let n=e.detail.settings,t=()=>{let o=[];for(let s of r.settings?.core?.fonts??[])o.push([[{type:"asset",name:"url",label:"File",value:s.url},{type:"title",name:"name",label:"Name",value:s.name}]]);return o};n.push({details:{label:"Core"},name:"core",tabs:[{label:"Font",fields:[[{label:"Fonts",type:"container",fields:[[{name:"fonts",type:"list",label:"Fonts List",template:[[{type:"asset",name:"url",label:"File",value:""},{type:"title",name:"name",label:"Name",value:""}]],entry:{url:"",name:""},fields:t()}]]}]]}]})},fe=()=>{let e=new CustomEvent(u.TYPE_DEFINITION,{detail:{definitions:{}}});return a(e),e.detail.definitions},me=async e=>{if(e===null||!(e instanceof HTMLCanvasElement)&&!(e instanceof OffscreenCanvas))throw new Error("Invalid value, not an empty or Canvas like");if(c==e)return;let n=new CustomEvent(u.CANVAS_CHANGE,{detail:{current:e,previous:c}});await y(n),c=n.detail.current,Q()},ye=()=>({meta:{document:r,generateId:j,layerDefinitions:fe,getCanvas:w,setCanvas:me},clone:{definitions:C,getOriginal:I,getClone:i},manage:{markAsLayer:P,remove:ae,removeVolatile:le,add:re,addVolatile:se,calcAndUpdateLayer:k},view:{calc:E,recalculate:H,draw:U,redraw:N,redrawDebounce:f(N),recalculateDebounce:m(H),move:oe,resize:ie},policies:{isLayer:ee,isClone:S},font:{load:G,reload:ce},setting:{set(e,n){let t=e.split(".");t.slice(-1)||t.pop(),_(t,n,r.settings)},get(e){let n=e.split(".");return n.slice(-1)||n.pop(),W(n,r.settings)??null},has:function(e){return!!(this.get(e)??!1)},retrieve:ue}}),R=e=>!!(e&&typeof e=="object"&&!Array.isArray(e)),F=(e,...n)=>{if(!n.length)return e;let t=n.shift();if(R(e)&&R(t))for(let o in t){let s=t[o];R(s)?(e[o]||Object.assign(e,{[o]:{}}),F(e[o],s)):Object.assign(e,{[o]:s})}return F(e,...n)},pe=async(e,n)=>{for(let o in n)D.setting.set(o,n[o]);let t=r;return t.settings=F({},t.settings,n),t.base=e,Promise.all((D.setting.get("core.fonts")??[]).map(o=>D.font.load(o))).then(()=>{y(new CustomEvent(u.FONTS_LOADED))}),t.layout=await D.view.recalculate(t,t.base),D.view.redraw(t.layout),t},Q=()=>{v&&v(),v=d.batch([{event:u.CLOSE,subscription:()=>{v()},anchor:c},{event:u.INIT,subscription:e=>{let{base:n,settings:t}=e.detail;return pe(n,t)},anchor:c},{event:u.SETTINGS,subscription:e=>{de(e)},anchor:c},{event:u.CALC,subscription:[{priority:-255,method:async e=>{e.detail.element!==null&&(e.detail.element=await D.clone.definitions(e.detail.element))}}],anchor:c}])},D=ye();return Q(),D}var K="core",J="0.0.5",A=class{#n;#t=null;#e=!1;#o=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(d){this.#n=d}async loadModules(d){return(await this.#r()).loadModules(d)}register(d){let{registration:g}=d.detail;g[K]={load:async()=>(!this.#t&&!this.#e&&(this.#e=new Promise(p=>{this.#i("core.js").then(c=>{this.#t=c.default,this.#e=!1,p()})})),this.#e&&await this.#e,console.log("load module3",this.#t),p=>this.#t({modules:p,herald:this.#n.herald})),version:J}}static subscriptions={[u.MODULES]:"register"};#i(d){return import(this.#n.marshal.getResourceUrl(this,d))}async#r(){return this.#o??=(await this.#i("helper.js")).default,new this.#o(this.#n.herald)}};export{A as AntetypeCore,q as Core,u as Event,K as ID,J as VERSION};
