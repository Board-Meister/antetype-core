var I=(n=>(n.STRUCTURE="antetype.structure",n.MIDDLE="antetype.structure.middle",n.BAR_BOTTOM="antetype.structure.bar.bottom",n.CENTER="antetype.structure.center",n.COLUMN_LEFT="antetype.structure.column.left",n.COLUMN_RIGHT="antetype.structure.column.right",n.BAR_TOP="antetype.structure.bar.top",n.MODULES="antetype.modules",n))(I||{});var D=class{#t;#r=null;#e=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(o){this.#t=o}async#a(o,s){if(!this.#e){let i=this.#t.minstrel.getResourceUrl(this,"core.js");this.#r=(await import(i)).default,this.#e=this.#r({canvas:s,modules:o,injected:this.#t})}return this.#e}async register(o){let{modules:s,canvas:i}=o.detail;s.core=await this.#a(s,i)}async init(o){if(!this.#e)throw new Error("Instance not loaded, trigger registration event first");let{base:s,settings:i}=o.detail;for(let u in i)this.#e.setting.set(u,i[u]);let c={type:"document",base:s,layout:[],start:{x:0,y:0},size:{w:0,h:0}},m=[];return(this.#e.setting.get("fonts")??[]).forEach(u=>{m.push(this.#e.font.load(u))}),await Promise.all(m),c.layout=await this.#e.view.recalculate(c,c.base),await this.#e.view.redraw(c.layout),c}static subscriptions={[I.MODULES]:"register","antetype.init":"init"}};function B({canvas:n,injected:{herald:o}}){if(!n)throw new Error("[Antetype Workspace] Provided canvas is empty");let s={},i=Symbol("layer"),c=e=>{o.dispatchSync(new CustomEvent("antetype.draw",{detail:{element:e}}))},m=e=>{for(let t of e)c(t)},u=async(e,t=null,r=0)=>{e.hierarchy={parent:t,position:r};let a=new CustomEvent("antetype.calc",{detail:{element:e}});return await o.dispatch(a),a.detail.element!==null&&y(a.detail.element),a.detail.element},v=e=>e[i]===!0,y=e=>(e[i]=!0,e),w=async(e,t)=>{y(e);let r=[];for(let a=0;a<t.length;a++){let l=await u(t[a],e,a);l!==null&&r.push(l)}return e.layout=r,r},f=async(e,t)=>{if(!t.hierarchy?.parent)return;let r=t.hierarchy.position,a=t.hierarchy.parent,l=await u(e,a,r);if(l===null){p(t,a,r);return}a.layout[r]=l},b=async(e,t,r)=>{e.start=r,await f(e,t)},g=async(e,t,r)=>{e.size=r,await f(e,t)},p=(e,t,r)=>{if(t.layout.splice(r,1),!e.hierarchy?.parent)return;let a=e.hierarchy.position,l=e.hierarchy.parent;l.layout.splice(a,1);for(let d=0;d<l.layout.length;d++){let h=l.layout[d];h.hierarchy&&(h.hierarchy.position=d)}},P=async e=>{let t=new FontFace(e.name,"url("+e.url+")");document.fonts.add(await t.load())};return{manage:{move:b,resize:g,remove:p},view:{calc:u,recalculate:w,draw:c,redraw:m,redrawDebounce:((e,t=100)=>{let r;return(...a)=>{clearTimeout(r),a[0]!=="clear"&&(r=setTimeout(()=>{e.apply({},a)},t))}})(m)},policies:{markAsLayer:y,isLayer:v},font:{load:P},setting:{set(e,t){s[e]=t},get(e){return s[e]??null},has:e=>!!(s[e]??!1)}}}export{B as default};
