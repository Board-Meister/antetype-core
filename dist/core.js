var C=(s=>(s.STRUCTURE="antetype.structure",s.MIDDLE="antetype.structure.middle",s.BAR_BOTTOM="antetype.structure.bar.bottom",s.CENTER="antetype.structure.center",s.COLUMN_LEFT="antetype.structure.column.left",s.COLUMN_RIGHT="antetype.structure.column.right",s.BAR_TOP="antetype.structure.bar.top",s.MODULES="antetype.modules",s))(C||{});var S=class{#t;#n=null;#e=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(i){this.#t=i}async#o(i,m){if(!this.#e){let u=this.#t.minstrel.getResourceUrl(this,"core.js");this.#n=(await import(u)).default,this.#e=this.#n({canvas:m,modules:i,injected:this.#t})}return this.#e}async register(i){let{modules:m,canvas:u}=i.detail;m.core=await this.#o(m,u)}async init(i){if(!this.#e)throw new Error("Instance not loaded, trigger registration event first");let{base:m,settings:u}=i.detail;for(let f in u)this.#e.setting.set(f,u[f]);let c=this.#e.meta.document;c.base=m;let w=[];return(this.#e.setting.get("fonts")??[]).forEach(f=>{w.push(this.#e.font.load(f))}),await Promise.all(w),c.layout=await this.#e.view.recalculate(c,c.base),await this.#e.view.redraw(c.layout),c}async cloneDefinitions(i){if(!this.#e)throw new Error("Instance not loaded, trigger registration event first");i.detail.element!==null&&(i.detail.element=await this.#e.clone.definitions(i.detail.element))}static subscriptions={[C.MODULES]:"register","antetype.init":"init","antetype.calc":[{method:"cloneDefinitions",priority:-255}]}};function B({modules:s,canvas:i}){let m=i.getContext("2d"),u=50,c=Symbol("original"),w=Symbol("clone"),f=n=>typeof n=="object"&&!Array.isArray(n)&&n!==null,h=function(n){return n[c]??n},g=function(n){return n[w]??n},y=async(n,d,I=0)=>{if(d.has(n))return d.get(n);if(n[c]||n.type==="document")return n;let p={};if(d.set(n,p),p[c]=n,n[w]=p,u<=I+1)throw console.error("We've reach limit depth!",n),new Error("limit reached");return await Promise.all(Object.keys(n).map(async D=>{let a=await b(n[D],n);f(a)?a=await y(a,d,I+1):Array.isArray(a)&&(a=await v(a,d,I+1)),p[D]=a})),p},v=async(n,d,I=0)=>{let p=[];if(u<=I+1)throw console.error("We've reach limit depth!",n),new Error("limit reached");return await Promise.all(n.map(async D=>{let a=await b(D,n);f(a)?a=await y(a,d,I+1):Array.isArray(a)&&(a=await v(a,d,I+1)),p.push(a)})),p},b=async(n,d)=>typeof n=="function"?await n(s,m,d):n;return{isClone:n=>n[c]===!0,cloneDefinitions:async n=>await y(n,new WeakMap),getClone:g,getOriginal:h}}function A(s){let{canvas:i,injected:{herald:m}}=s;if(!i)throw new Error("[Antetype Workspace] Provided canvas is empty");let u={},c=Symbol("layer"),{cloneDefinitions:w,isClone:f,getOriginal:h,getClone:g}=B(s),y={type:"document",base:[],layout:[],start:{x:0,y:0},size:{w:0,h:0}},v=e=>{m.dispatchSync(new CustomEvent("antetype.draw",{detail:{element:e}}))},b=(e=y.layout)=>{for(let t of e)v(t)},P=async(e,t=null,o=0)=>{e.hierarchy={parent:t,position:o};let r=new CustomEvent("antetype.calc",{detail:{element:e}});return await m.dispatch(r),r.detail.element!==null&&n(r.detail.element),r.detail.element},R=e=>e[c]===!0,n=e=>(e[c]=!0,e),d=async(e=y,t=y.base)=>{n(e);let o=[];for(let r=0;r<t.length;r++){let l=await P(t[r],e,r);l!==null&&o.push(l)}return e.layout=o,o},I=async(e,t)=>{if(!t.hierarchy?.parent)return;let o=t.hierarchy.position,r=t.hierarchy.parent,l=await P(e,r,o);if(l===null){x(t),L(t);return}r.layout[o]=l},p=async(e,t,o)=>{e.start=o,await I(e,t)},D=async(e,t,o)=>{e.size=o,await I(e,t)},a=(e,t=null,o=null)=>{t&&f(t)&&(t=h(t));let r=t?t.layout:y.base;t??=y,o??=r.length,T(e,t,o,r)},E=(e,t=null,o=null)=>{t&&!f(t)&&(t=g(t)),t??=y,o??=t.layout.length,T(e,t,o,t.layout)},T=(e,t,o,r)=>{r.splice(o,0,e),e.hierarchy={position:o,parent:t}},x=e=>{if(!e.hierarchy?.parent)return;let t=e.hierarchy.position,o=h(e.hierarchy.parent),r=(o?.type==="document"?o.base:o?.layout)??[];r.splice(t,1);for(let l=0;l<r.length;l++){let k=r[l];k.hierarchy&&(k.hierarchy.position=l)}},L=e=>{if(!e.hierarchy?.parent)return;let t=e.hierarchy.position,r=g(e.hierarchy.parent).layout;r.splice(t,1);for(let l=0;l<r.length;l++){let k=r[l];k.hierarchy&&(k.hierarchy.position=l)}},U=async e=>{let t=new FontFace(e.name,"url("+e.url+")");document.fonts.add(await t.load())};return{meta:{document:y},clone:{definitions:w,getOriginal:h,getClone:g},manage:{markAsLayer:n,move:p,resize:D,remove:x,removeVolatile:L,add:a,addVolatile:E},view:{calc:P,recalculate:d,draw:v,redraw:b,redrawDebounce:((e,t=100)=>{let o;return(...r)=>{clearTimeout(o),r[0]!=="clear"&&(o=setTimeout(()=>{e.apply({},r)},t))}})(b)},policies:{isLayer:R,isClone:f},font:{load:U},setting:{set(e,t){u[e]=t},get(e){return u[e]??null},has:e=>!!(u[e]??!1)}}}export{A as default};
