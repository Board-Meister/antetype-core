var m={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition"};function L({modules:k,canvas:x}){let p=x.getContext("2d"),w=50,g=Symbol("original"),S=Symbol("clone"),T=o=>typeof o=="object"&&!Array.isArray(o)&&o!==null,h=function(o){return o[g]??o},c=function(o){return o[S]??o},u=async(o,l,d=0)=>{if(l.has(o))return l.get(o);if(o[g]||o.type==="document")return o;let f={};if(l.set(o,f),f[g]=o,o[S]=f,w<=d+1)throw console.error("We've reach limit depth!",o),new Error("limit reached");for(let I of Object.keys(o)){let s=await b(o[I],o);T(s)?s=await u(s,l,d+1):Array.isArray(s)&&(s=await a(s,l,d+1)),f[I]=s}return f},a=async(o,l,d=0)=>{let f=[];if(w<=d+1)throw console.error("We've reach limit depth!",o),new Error("limit reached");for(let I of o){let s=await b(I,o);T(s)?s=await u(s,l,d+1):Array.isArray(s)&&(s=await a(s,l,d+1)),f.push(s)}return f},b=async(o,l)=>typeof o=="function"?await o(k,p,l):o;return{isClone:o=>o[g]===!0,cloneDefinition:async o=>await u(o,new WeakMap),getClone:c,getOriginal:h}}function ee(k){let{canvas:x,herald:p}=k;if(!x)throw new Error("[Antetype Workspace] Provided canvas is empty");let w=[],g=[],S=Symbol("layer"),{cloneDefinition:T,isClone:h,getOriginal:c,getClone:u}=L(k),a={type:"document",base:[],layout:[],start:{x:0,y:0},size:{w:0,h:0},settings:{core:{fonts:[]}}};console.log(a);let b=(e,n=100)=>{let t;return(...i)=>{clearTimeout(t),i[0]!=="clear"&&(t=setTimeout(()=>{e.apply({},i)},n))}},M=b(()=>{p.dispatch(new CustomEvent(m.RECALC_FINISHED))}),E=b(async()=>{g.length!=0&&(await g.shift()(),E())}),o=e=>{p.dispatchSync(new CustomEvent(m.DRAW,{detail:{element:e}}))},l=(e=a.layout)=>{for(let n of e)o(n)},d=(e,n,t)=>{e.hierarchy??={parent:n,position:t},n&&(e.hierarchy.parent=n),t&&(e.hierarchy.position=t)},f=e=>{let n=!1,t=r=>{setTimeout(()=>{if(!n){t(r);return}e().then(y=>{r(y)})})},i=new Promise(r=>{t(r)});return g.push(()=>(n=!0,i)),E(),i},I=async(e,n=null,t=null,i=null)=>{if(i!==(w[0]??null))return f(()=>I(e,n,t,i));let r=c(e);t??=r.hierarchy?.position??0,d(r,n?c(n):null,t);let y=new CustomEvent(m.CALC,{detail:{element:e,sessionId:i}});await p.dispatch(y);let v=y.detail.element;return v!==null&&(P(v),d(v,n?u(n):null,t)),v},s=()=>Math.random().toString(16).slice(2),V=e=>typeof c(e)[S]=="number",P=e=>{e[S]=!0,c(e).id??=s();let n=u(e);return n.id||Object.defineProperty(n,"id",{get(){return c(e).id}}),e},H=()=>{let e=Symbol("illustrator_session_id"+String(Math.random()));return w.push(e),e},W=()=>{w.shift()},G=async(e=a,n=a.base,t=null)=>{let i=t??H();P(e);let r=[];for(let y=0;y<n.length;y++){let v=await I(n[y],e,y,i);v!==null&&r.push(v)}return e.layout=r,M(),t||W(),r},R=async e=>{if(!e.hierarchy?.parent)return;let n=e.hierarchy.position,t=e.hierarchy.parent,i=await I(e,t,n);if(i===null){U(e),O(e);return}u(t).layout[n]=i},_=async(e,n)=>{e.start=n,await R(e)},j=async(e,n)=>{e.size=n,await R(e)},Q=(e,n=null,t=null)=>{n&&h(n)&&(n=c(n));let i=n?n.layout:a.base;n??=a,n.base&&(i=n.base),t??=i.length,A(e,n,t,i)},Y=(e,n=null,t=null)=>{n&&!h(n)&&(n=u(n)),n??=a,t??=n.layout.length,A(e,n,t,n.layout)},A=(e,n,t,i)=>{i.splice(t,0,e),e.hierarchy={position:t,parent:n},C(i)},C=e=>{for(let n=0;n<e.length;n++){let t=e[n];t.hierarchy&&(t.hierarchy.position=n)}},U=e=>{if(!e.hierarchy?.parent)return;let n=e.hierarchy.position,t=c(e.hierarchy.parent),i=(t?.type==="document"?t.base:t?.layout)??[];i[n]===c(e)&&(i.splice(n,1),C(i))},O=e=>{if(!e.hierarchy?.parent)return;let n=e.hierarchy.position,i=u(e.hierarchy.parent).layout;i[n]===u(e)&&(i.splice(n,1),C(i))},X=async e=>{try{let n=new FontFace(e.name,"url("+e.url+")");document.fonts.add(await n.load())}catch(n){console.error("Font couldn't be loaded:",e.name+",",e.url,n)}},K=async function(e={}){let n=new CustomEvent(m.SETTINGS,{detail:{settings:[],additional:e}});return await p.dispatch(n),n.detail.settings},z=(e,n,t)=>{if(e.length<=1){t[e[0]]=n;return}if(t[e[0]]??={},typeof t[e[0]]!="object"||t[e[0]]===null){console.warn("Cannot set setting, due to one of destination not being an object",e,t,n);return}z(e.slice(1),n,t[e[0]])},N=(e,n)=>{if(e.length<=1)return n[e[0]];if(n[e[0]])return N(e.slice(1),n[e[0]])},q=e=>{let n=e.detail.settings,t=()=>{let i=[];for(let r of a.settings?.core?.fonts??[])i.push([[{type:"asset",name:"url",label:"File",value:r.url},{type:"title",name:"name",label:"Name",value:r.name}]]);return i};n.push({details:{label:"Core"},name:"core",tabs:[{label:"Font",fields:[[{label:"Fonts",type:"container",fields:[[{name:"fonts",type:"list",label:"Fonts List",template:[[{type:"asset",name:"url",label:"File",value:""},{type:"title",name:"name",label:"Name",value:""}]],entry:{url:"",name:""},fields:t()}]]}]]}]})},J=()=>{let e=new CustomEvent(m.TYPE_DEFINITION,{detail:{definitions:{}}});return p.dispatchSync(e),e.detail.definitions},D={meta:{document:a,generateId:s,layerDefinitions:J},clone:{definitions:T,getOriginal:c,getClone:u},manage:{markAsLayer:P,move:_,resize:j,remove:U,removeVolatile:O,add:Q,addVolatile:Y,calcAndUpdateLayer:R},view:{calc:I,recalculate:G,draw:o,redraw:l,redrawDebounce:b(l)},policies:{isLayer:V,isClone:h},font:{load:X},setting:{set(e,n){let t=e.split(".");t.slice(-1)||t.pop(),z(t,n,a.settings)},get(e){let n=e.split(".");return n.slice(-1)||n.pop(),N(n,a.settings)??null},has:function(e){return!!(this.get(e)??!1)},retrieveSettingsDefinition:K,setSettingsDefinition:q}},F=e=>!!(e&&typeof e=="object"&&!Array.isArray(e)),B=(e,...n)=>{if(!n.length)return e;let t=n.shift();if(F(e)&&F(t))for(let i in t){let r=t[i];F(r)?(e[i]||Object.assign(e,{[i]:{}}),B(e[i],r)):Object.assign(e,{[i]:r})}return B(e,...n)},Z=async(e,n)=>{for(let r in n)D.setting.set(r,n[r]);let t=a;t.settings=B({},a.settings,n),t.base=e;let i=[];return(D.setting.get("core.fonts")??[]).forEach(r=>{i.push(D.font.load(r))}),await Promise.all(i),t.layout=await D.view.recalculate(t,t.base),D.view.redraw(t.layout),t},$=p.batch([{event:m.CLOSE,subscription:()=>{$()}},{event:m.INIT,subscription:e=>{let{base:n,settings:t}=e.detail;return Z(n,t)}},{event:m.SETTINGS,subscription:e=>{D.setting.setSettingsDefinition(e)}},{event:m.CALC,subscription:[{priority:-255,method:async e=>{e.detail.element!==null&&(e.detail.element=await D.clone.definitions(e.detail.element))}}]}]);return D}export{ee as default};
