var c={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded",CANVAS_CHANGE:"antetype.canvas.change"};function L(x){let I=Symbol("original"),D=Symbol("clone"),C=i=>typeof i=="object"&&!Array.isArray(i)&&i!==null,w=function(i){return i[I]??i},S=function(i){return i[D]??i},h=async(i,l,f=0)=>{if(l.has(i))return l.get(i);if(i[I]||i.type==="document")return i;let d={};if(l.set(i,d),d[I]=i,i[D]=d,50<=f+1)throw console.error("We've reach limit depth!",i),new Error("limit reached");for(let v of Object.keys(i)){let r=await u(i[v],i);C(r)?r=await h(r,l,f+1):Array.isArray(r)&&(r=await b(r,l,f+1)),d[v]=r}return d},b=async(i,l,f=0)=>{let d=[];if(50<=f+1)throw console.error("We've reach limit depth!",i),new Error("limit reached");for(let v of i){let r=await u(v,i);C(r)?r=await h(r,l,f+1):Array.isArray(r)&&(r=await b(r,l,f+1)),d.push(r)}return d},u=async(i,l)=>typeof i=="function"?await i(x()?.getContext("2d"),l):i;return{isClone:i=>!!i[I],cloneDefinition:async i=>await h(i,new WeakMap),getClone:S,getOriginal:w}}function te(x){let{herald:m}=x,I=[],D=[],C=Symbol("layer"),w=null,S=()=>w,{cloneDefinition:h,isClone:b,getOriginal:u,getClone:p}=L(S),a={type:"document",base:[],layout:[],start:{x:0,y:0},size:{w:0,h:0},settings:{core:{fonts:[]}}};console.log(a);let i=(e,n=100)=>{let t;return(...o)=>{clearTimeout(t),o[0]!=="clear"&&(t=setTimeout(()=>{e.apply({},o)},n))}},l=i(()=>{m.dispatch(new CustomEvent(c.RECALC_FINISHED))}),f=i(async()=>{D.length!=0&&(await D.shift()(),f())}),d=e=>{m.dispatchSync(new CustomEvent(c.DRAW,{detail:{element:e}}))},v=(e=a.layout)=>{for(let n of e)d(n)},r=(e,n,t)=>{e.hierarchy??={parent:n,position:t},n&&(e.hierarchy.parent=n),t&&(e.hierarchy.position=t)},V=e=>{let n=!1,t=s=>{setTimeout(()=>{if(!n){t(s);return}e().then(y=>{s(y)})})},o=new Promise(s=>{t(s)});return D.push(()=>(n=!0,o)),f(),o},E=async(e,n=null,t=null,o=null)=>{if(o!==(I[0]??null))return V(()=>E(e,n,t,o));let s=u(e);t??=s.hierarchy?.position??0,r(s,n?u(n):null,t);let y=new CustomEvent(c.CALC,{detail:{element:e,sessionId:o}});await m.dispatch(y);let B=y.detail.element;return k(B),r(B,n?p(n):null,t),B},M=()=>Math.random().toString(16).slice(2),z=e=>p(e)[C]===!0,k=e=>{e[C]=!0,u(e).id??=M();let n=p(e);return n.id||Object.defineProperty(n,"id",{get(){return u(e).id}}),e},G=()=>{let e=Symbol("illustrator_session_id"+String(Math.random()));return I.push(e),e},H=()=>{I.shift()},_=async(e=a,n=a.base,t=null)=>{let o=t??G();k(e);let s=[];for(let y=0;y<n.length;y++)s.push(await E(n[y],e,y,o));return e.layout=s,l(),t||H(),s},T=async e=>{if(!e.hierarchy?.parent)return;let n=e.hierarchy.position,t=e.hierarchy.parent;p(t).layout[n]=await E(e,t,n)},W=async(e,n)=>{e.start=n,await T(e)},j=async(e,n)=>{e.size=n,await T(e)},Q=(e,n=null,t=null)=>{n&&b(n)&&(n=u(n));let o=n?n.layout:a.base;n??=a,n.base&&(o=n.base),t??=o.length,A(e,n,t,o)},Y=(e,n=null,t=null)=>{n&&!b(n)&&(n=p(n)),n??=a,t??=n.layout.length,A(e,n,t,n.layout)},A=(e,n,t,o)=>{o.splice(t,0,e),e.hierarchy={position:t,parent:n},R(o)},R=e=>{for(let n=0;n<e.length;n++){let t=e[n];t.hierarchy&&(t.hierarchy.position=n)}},X=e=>{if(!e.hierarchy?.parent)return;let n=e.hierarchy.position,t=u(e.hierarchy.parent),o=(t?.type==="document"?t.base:t?.layout)??[];o[n]===u(e)&&(o.splice(n,1),R(o))},q=e=>{if(!e.hierarchy?.parent)return;let n=e.hierarchy.position,o=p(e.hierarchy.parent).layout;o[n]===p(e)&&(o.splice(n,1),R(o))},O=async e=>{try{let n=new FontFace(e.name,"url("+e.url+")"),t=document.fonts.add(await n.load());return g.view.redrawDebounce(),t}catch(n){return console.error("Font couldn't be loaded:",e.name+",",e.url,n),null}},K=async()=>{document.fonts.clear();let e=[];for(let n of a.settings?.core?.fonts??[])e.push(O(n));return Promise.all(e)},J=async function(e={}){let n=new CustomEvent(c.SETTINGS,{detail:{settings:[],additional:e}});return await m.dispatch(n),n.detail.settings},U=(e,n,t)=>{if(e.length<=1){t[e[0]]=n;return}if(t[e[0]]??={},typeof t[e[0]]!="object"||t[e[0]]===null){console.warn("Cannot set setting, due to one of destination not being an object",e,t,n);return}U(e.slice(1),n,t[e[0]])},N=(e,n)=>{if(e.length<=1)return n[e[0]];if(n[e[0]])return N(e.slice(1),n[e[0]])},Z=e=>{let n=e.detail.settings,t=()=>{let o=[];for(let s of a.settings?.core?.fonts??[])o.push([[{type:"asset",name:"url",label:"File",value:s.url},{type:"title",name:"name",label:"Name",value:s.name}]]);return o};n.push({details:{label:"Core"},name:"core",tabs:[{label:"Font",fields:[[{label:"Fonts",type:"container",fields:[[{name:"fonts",type:"list",label:"Fonts List",template:[[{type:"asset",name:"url",label:"File",value:""},{type:"title",name:"name",label:"Name",value:""}]],entry:{url:"",name:""},fields:t()}]]}]]}]})},$=()=>{let e=new CustomEvent(c.TYPE_DEFINITION,{detail:{definitions:{}}});return m.dispatchSync(e),e.detail.definitions},g={meta:{document:a,generateId:M,layerDefinitions:$,getCanvas:S,setCanvas(e){if(e===null||!(e instanceof HTMLCanvasElement)&&!(e instanceof OffscreenCanvas))throw new Error("Invalid value, not an empty or Canvas like");w!=e&&m.dispatch(new CustomEvent(c.CANVAS_CHANGE,{detail:{current:e,previous:w}})),w=e}},clone:{definitions:h,getOriginal:u,getClone:p},manage:{markAsLayer:k,remove:X,removeVolatile:q,add:Q,addVolatile:Y,calcAndUpdateLayer:T},view:{calc:E,recalculate:_,draw:d,redraw:v,redrawDebounce:i(v),move:W,resize:j},policies:{isLayer:z,isClone:b},font:{load:O,reload:K},setting:{set(e,n){let t=e.split(".");t.slice(-1)||t.pop(),U(t,n,a.settings)},get(e){let n=e.split(".");return n.slice(-1)||n.pop(),N(n,a.settings)??null},has:function(e){return!!(this.get(e)??!1)},retrieve:J}},P=e=>!!(e&&typeof e=="object"&&!Array.isArray(e)),F=(e,...n)=>{if(!n.length)return e;let t=n.shift();if(P(e)&&P(t))for(let o in t){let s=t[o];P(s)?(e[o]||Object.assign(e,{[o]:{}}),F(e[o],s)):Object.assign(e,{[o]:s})}return F(e,...n)},ee=async(e,n)=>{for(let o in n)g.setting.set(o,n[o]);let t=a;return t.settings=F({},t.settings,n),t.base=e,Promise.all((g.setting.get("core.fonts")??[]).map(o=>g.font.load(o))).then(()=>{m.dispatch(new CustomEvent(c.FONTS_LOADED))}),t.layout=await g.view.recalculate(t,t.base),g.view.redraw(t.layout),t},ne=m.batch([{event:c.CLOSE,subscription:()=>{ne()}},{event:c.INIT,subscription:e=>{let{base:n,settings:t}=e.detail;return ee(n,t)}},{event:c.SETTINGS,subscription:e=>{Z(e)}},{event:c.CALC,subscription:[{priority:-255,method:async e=>{e.detail.element!==null&&(e.detail.element=await g.clone.definitions(e.detail.element))}}]}]);return g}export{te as default};
