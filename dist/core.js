var l={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded",CANVAS_CHANGE:"antetype.canvas.change"};var S=Symbol("original"),X=Symbol("clone");function A(k){let v=i=>typeof i=="object"&&!Array.isArray(i)&&i!==null,w=function(i){return i[S]??i},c=function(i){return i[X]??i},I=async(i,s,d=0)=>{if(s.has(i))return s.get(i);if(i[S]||i.type==="document")return i;let y={};if(s.set(i,y),y[S]=i,i[X]=y,50<=d+1)throw console.error("We've reach limit depth!",i),new Error("limit reached");for(let m of Object.keys(i)){let a=await C(i[m],i);v(a)?a=await I(a,s,d+1):Array.isArray(a)&&(a=await b(a,s,d+1)),y[m]=a}return y},b=async(i,s,d=0)=>{let y=[];if(50<=d+1)throw console.error("We've reach limit depth!",i),new Error("limit reached");for(let m of i){let a=await C(m,i);v(a)?a=await I(a,s,d+1):Array.isArray(a)&&(a=await b(a,s,d+1)),y.push(a)}return y},C=async(i,s)=>typeof i=="function"?await i(k()?.getContext("2d"),s):i;return{isClone:i=>!!i[S],cloneDefinition:async i=>await I(i,new WeakMap),getClone:c,getOriginal:w}}var q=Symbol("layer");function me(k){let{herald:D}=k,v=[],w=[],c=null,I=null,b=()=>c,{cloneDefinition:C,isClone:h,getOriginal:p,getClone:i}=A(b),s={type:"document",base:[],layout:[],start:{x:0,y:0},size:{w:0,h:0},settings:{core:{fonts:[]}}};console.log(s);let d=(e,n=100)=>{let t;return(...o)=>{clearTimeout(t),o[0]!=="clear"&&(t=setTimeout(()=>{e.apply({},o)},n))}},y=(e,n=100)=>{let t,o,r,u=new Promise(g=>{r=g});return async(...g)=>(clearTimeout(t),o&&o(),g[0]==="clear"?(r(void 0),u):(await new Promise((L,M)=>{t=setTimeout(()=>{L(!0)},n),o=M}).catch(()=>!1)&&e.apply({},g).then(L=>{r(L),u=new Promise(M=>{r=M})}),u))},m=(e,n={})=>D.dispatch(e,{origin:c,...n}),a=(e,n={})=>{D.dispatchSync(e,{origin:c,...n})},K=d(()=>{m(new CustomEvent(l.RECALC_FINISHED))}),N=d(async()=>{w.length!=0&&(await w.shift()(),N())}),O=e=>{a(new CustomEvent(l.DRAW,{detail:{element:e}}))},U=(e=s.layout)=>{for(let n of e)O(n)},V=(e,n,t)=>{e.hierarchy??={parent:n,position:t},n&&(e.hierarchy.parent=n),t&&(e.hierarchy.position=t)},J=e=>{let n=!1,t=r=>{setTimeout(()=>{if(!n){t(r);return}e().then(u=>{r(u)})})},o=new Promise(r=>{t(r)});return w.push(()=>(n=!0,o)),N(),o},E=async(e,n=null,t=null,o=null)=>{if(o!==(v[0]??null))return J(()=>E(e,n,t,o));let r=p(e);t??=r.hierarchy?.position??0,V(r,n?p(n):null,t);let u=new CustomEvent(l.CALC,{detail:{element:e,sessionId:o}});await m(u);let g=u.detail.element;return x(g),V(g,n?i(n):null,t),g},G=()=>Math.random().toString(16).slice(2),Z=e=>i(e)[q]===!0,x=e=>{e[q]=!0,p(e).id??=G();let n=i(e);return n.id||Object.defineProperty(n,"id",{get(){return p(e).id}}),e},$=()=>{let e=Symbol("illustrator_session_id"+String(Math.random()));return v.push(e),e},ee=()=>{v.shift()},z=async(e=s,n=s.base,t=null)=>{let o=t??$();x(e);let r=[];for(let u=0;u<n.length;u++)r.push(await E(n[u],e,u,o));return e.layout=r,K(),t||ee(),r},P=async e=>{if(!e.hierarchy?.parent)return;let n=e.hierarchy.position,t=e.hierarchy.parent;i(t).layout[n]=await E(e,t,n)},ne=async(e,n)=>{e.start=n,await P(e)},te=async(e,n)=>{e.size=n,await P(e)},oe=(e,n=null,t=null)=>{n&&h(n)&&(n=p(n));let o=n?n.layout:s.base;n??=s,n.base&&(o=n.base),t??=o.length,H(e,n,t,o)},ie=(e,n=null,t=null)=>{n&&!h(n)&&(n=i(n)),n??=s,t??=n.layout.length,H(e,n,t,n.layout)},H=(e,n,t,o)=>{o.splice(t,0,e),e.hierarchy={position:t,parent:n},T(o)},T=e=>{for(let n=0;n<e.length;n++){let t=e[n];t.hierarchy&&(t.hierarchy.position=n)}},re=e=>{if(!e.hierarchy?.parent)return;let n=e.hierarchy.position,t=p(e.hierarchy.parent),o=(t?.type==="document"?t.base:t?.layout)??[];o[n]===p(e)&&(o.splice(n,1),T(o))},se=e=>{if(!e.hierarchy?.parent)return;let n=e.hierarchy.position,o=i(e.hierarchy.parent).layout;o[n]===i(e)&&(o.splice(n,1),T(o))},_=async e=>{try{let n=new FontFace(e.name,"url("+e.url+")"),t=document.fonts.add(await n.load());return f.view.redrawDebounce(),t}catch(n){return console.error("Font couldn't be loaded:",e.name+",",e.url,n),null}},ae=async()=>{document.fonts.clear();let e=[];for(let n of s.settings?.core?.fonts??[])e.push(_(n));return Promise.all(e)},le=async function(e={}){let n=new CustomEvent(l.SETTINGS,{detail:{settings:[],additional:e}});return await m(n),n.detail.settings},W=(e,n,t)=>{if(e.length<=1){t[e[0]]=n;return}if(t[e[0]]??={},typeof t[e[0]]!="object"||t[e[0]]===null){console.warn("Cannot set setting, due to one of destination not being an object",e,t,n);return}W(e.slice(1),n,t[e[0]])},j=(e,n)=>{if(e.length<=1)return n[e[0]];if(n[e[0]])return j(e.slice(1),n[e[0]])},Q=e=>{let n=e.detail.settings,t=()=>{let o=[];for(let r of s.settings?.core?.fonts??[])o.push([[{type:"asset",name:"url",label:"File",value:r.url},{type:"title",name:"name",label:"Name",value:r.name}]]);return o};n.push({details:{label:"Core"},name:"core",tabs:[{label:"Font",fields:[[{label:"Fonts",type:"container",fields:[[{name:"fonts",type:"list",label:"Fonts List",template:[[{type:"asset",name:"url",label:"File",value:""},{type:"title",name:"name",label:"Name",value:""}]],entry:{url:"",name:""},fields:t()}]]}]]}]})},ce=()=>{let e=new CustomEvent(l.TYPE_DEFINITION,{detail:{definitions:{}}});return a(e),e.detail.definitions},ue=async e=>{if(e===null||!(e instanceof HTMLCanvasElement)&&!(e instanceof OffscreenCanvas))throw new Error("Invalid value, not an empty or Canvas like");if(c==e)return;let n=new CustomEvent(l.CANVAS_CHANGE,{detail:{current:e,previous:c}});await m(n),c=n.detail.current,ye()},de=e=>{let n=f.meta.getCanvas();return typeof e.subscription=="function"||typeof e.subscription=="string"?e.anchor=n:Array.isArray(e.subscription)?e.subscription.forEach(t=>{t.anchor=n}):e.subscription.anchor=n,e},R=(e,n=null)=>{n??=f.meta.getCanvas();let t=D.batch([{event:l.CLOSE,subscription:()=>{t()},anchor:n},{event:l.CANVAS_CHANGE,subscription:({detail:{current:o}})=>{t(),R(e,o)},anchor:n},...e.reduce((o,r)=>[...o,de(r)],[])]);return t},fe=()=>({event:{batch:R},meta:{document:s,generateId:G,layerDefinitions:ce,getCanvas:b,setCanvas:ue},clone:{definitions:C,getOriginal:p,getClone:i},manage:{markAsLayer:x,remove:re,removeVolatile:se,add:oe,addVolatile:ie,calcAndUpdateLayer:P},view:{calc:E,recalculate:z,draw:O,redraw:U,redrawDebounce:d(U),recalculateDebounce:y(z),move:ne,resize:te},policies:{isLayer:Z,isClone:h},font:{load:_,reload:ae},setting:{set(e,n){let t=e.split(".");t.slice(-1)||t.pop(),W(t,n,s.settings)},get(e){let n=e.split(".");return n.slice(-1)||n.pop(),j(n,s.settings)??null},has:function(e){return!!(this.get(e)??!1)},retrieve:le}}),F=e=>!!(e&&typeof e=="object"&&!Array.isArray(e)),B=(e,...n)=>{if(!n.length)return e;let t=n.shift();if(F(e)&&F(t))for(let o in t){let r=t[o];F(r)?(e[o]||Object.assign(e,{[o]:{}}),B(e[o],r)):Object.assign(e,{[o]:r})}return B(e,...n)},Y=async(e,n)=>{for(let o in n)f.setting.set(o,n[o]);let t=s;return t.settings=B({},t.settings,n),t.base=e,Promise.all((f.setting.get("core.fonts")??[]).map(o=>f.font.load(o))).then(()=>{m(new CustomEvent(l.FONTS_LOADED))}),t.layout=await f.view.recalculate(t,t.base),f.view.redraw(t.layout),t},ye=()=>{I&&I(),I=D.batch([{event:l.CLOSE,subscription:()=>{I()},anchor:c},{event:l.INIT,subscription:e=>{let{base:n,settings:t}=e.detail;return Y(n,t)},anchor:c},{event:l.SETTINGS,subscription:e=>{Q(e)},anchor:c},{event:l.CALC,subscription:[{priority:-255,method:async e=>{e.detail.element!==null&&(e.detail.element=await f.clone.definitions(e.detail.element))}}],anchor:c}])},f=fe();return R([{event:l.INIT,subscription:e=>{let{base:n,settings:t}=e.detail;return Y(n,t)},anchor:c},{event:l.SETTINGS,subscription:e=>{Q(e)},anchor:c},{event:l.CALC,subscription:[{priority:-255,method:async e=>{e.detail.element!==null&&(e.detail.element=await f.clone.definitions(e.detail.element))}}],anchor:c}]),f}export{me as default};
