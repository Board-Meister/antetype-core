function F({modules:S,canvas:k}){let D=k.getContext("2d"),p=50,I=Symbol("original"),b=Symbol("clone"),C=i=>typeof i=="object"&&!Array.isArray(i)&&i!==null,h=function(i){return i[I]??i},c=function(i){return i[b]??i},u=async(i,l,d=0)=>{if(l.has(i))return l.get(i);if(i[I]||i.type==="document")return i;let f={};if(l.set(i,f),f[I]=i,i[b]=f,p<=d+1)throw console.error("We've reach limit depth!",i),new Error("limit reached");for(let m of Object.keys(i)){let s=await w(i[m],i);C(s)?s=await u(s,l,d+1):Array.isArray(s)&&(s=await a(s,l,d+1)),f[m]=s}return f},a=async(i,l,d=0)=>{let f=[];if(p<=d+1)throw console.error("We've reach limit depth!",i),new Error("limit reached");for(let m of i){let s=await w(m,i);C(s)?s=await u(s,l,d+1):Array.isArray(s)&&(s=await a(s,l,d+1)),f.push(s)}return f},w=async(i,l)=>typeof i=="function"?await i(S,D,l):i;return{isClone:i=>i[I]===!0,cloneDefinition:async i=>await u(i,new WeakMap),getClone:c,getOriginal:h}}function J(S){let{canvas:k,injected:{herald:D}}=S;if(!k)throw new Error("[Antetype Workspace] Provided canvas is empty");let p=[],I=[],b=Symbol("layer"),{cloneDefinition:C,isClone:h,getOriginal:c,getClone:u}=F(S),a={type:"document",base:[],layout:[],start:{x:0,y:0},size:{w:0,h:0},settings:{core:{fonts:[]}}};console.log(a);let w=(e,n=100)=>{let t;return(...o)=>{clearTimeout(t),o[0]!=="clear"&&(t=setTimeout(()=>{e.apply({},o)},n))}},L=w(()=>{D.dispatch(new CustomEvent("antetype.recalc.finished"))}),P=w(async()=>{I.length!=0&&(await I.shift()(),P())}),i=e=>{D.dispatchSync(new CustomEvent("antetype.draw",{detail:{element:e}}))},l=(e=a.layout)=>{for(let n of e)i(n)},d=(e,n,t)=>{e.hierarchy??={parent:n,position:t},n&&(e.hierarchy.parent=n),t&&(e.hierarchy.position=t)},f=e=>{let n=!1,t=new Promise(async o=>{for(;!n;)await new Promise(r=>setTimeout(r,100));e().then(r=>{o(r)})});return I.push(()=>(n=!0,t)),P(),t},m=async(e,n=null,t=null,o=null)=>{if(o!==(p[0]??null))return f(()=>m(e,n,t,o));let r=c(e);t??=r.hierarchy?.position??0,d(r,n?c(n):null,t);let y=new CustomEvent("antetype.calc",{detail:{element:e,sessionId:o}});await D.dispatch(y);let g=y.detail.element;return g!==null&&(R(g),d(g,n?u(n):null,t)),g},s=()=>Math.random().toString(16).slice(2),z=e=>typeof c(e)[b]=="number",R=e=>{e[b]=!0,c(e).id??=s();let n=u(e);return n.id||Object.defineProperty(n,"id",{get(){return c(e).id}}),e},V=()=>{let e=Symbol("illustrator_session_id"+String(Math.random()));return p.push(e),e},H=()=>{p.shift()},N=async(e=a,n=a.base,t=null)=>{let o=t??V();R(e);let r=[];for(let y=0;y<n.length;y++){let g=await m(n[y],e,y,o);g!==null&&r.push(g)}return e.layout=r,L(),t||H(),r},x=async e=>{if(!e.hierarchy?.parent)return;let n=e.hierarchy.position,t=e.hierarchy.parent,o=await m(e,t,n);if(o===null){A(e),U(e);return}u(t).layout[n]=o},W=async(e,n)=>{e.start=n,await x(e)},G=async(e,n)=>{e.size=n,await x(e)},_=(e,n=null,t=null)=>{n&&h(n)&&(n=c(n));let o=n?n.layout:a.base;n??=a,n.base&&(o=n.base),t??=o.length,M(e,n,t,o)},Q=(e,n=null,t=null)=>{n&&!h(n)&&(n=u(n)),n??=a,t??=n.layout.length,M(e,n,t,n.layout)},M=(e,n,t,o)=>{o.splice(t,0,e),e.hierarchy={position:t,parent:n},E(o)},E=e=>{for(let n=0;n<e.length;n++){let t=e[n];t.hierarchy&&(t.hierarchy.position=n)}},A=e=>{if(!e.hierarchy?.parent)return;let n=e.hierarchy.position,t=c(e.hierarchy.parent),o=(t?.type==="document"?t.base:t?.layout)??[];o[n]===c(e)&&(o.splice(n,1),E(o))},U=e=>{if(!e.hierarchy?.parent)return;let n=e.hierarchy.position,o=u(e.hierarchy.parent).layout;o[n]===u(e)&&(o.splice(n,1),E(o))},X=async e=>{try{let n=new FontFace(e.name,"url("+e.url+")");document.fonts.add(await n.load())}catch(n){console.error("Font couldn't be loaded:",e.name+",",e.url,n)}},Y=async function(e={}){let n=new CustomEvent("antetype.settings.definition",{detail:{settings:[],additional:e}});return await D.dispatch(n),n.detail.settings},j=(e,n,t)=>{if(e.length<=1){t[e[0]]=n;return}if(t[e[0]]??={},typeof t[e[0]]!="object"||t[e[0]]===null){console.warn("Cannot set setting, due to one of destination not being an object",e,t,n);return}j(e.slice(1),n,t[e[0]])},O=(e,n)=>{if(e.length<=1)return n[e[0]];if(n[e[0]])return O(e.slice(1),n[e[0]])},q=e=>{let n=e.detail.settings,t=()=>{let o=[];for(let r of a.settings?.core?.fonts??[])o.push([[{type:"asset",name:"url",label:"File",value:r.url},{type:"title",name:"name",label:"Name",value:r.name}]]);return o};n.push({details:{label:"Core"},name:"core",tabs:[{label:"Font",fields:[[{label:"Fonts",type:"container",fields:[[{name:"fonts",type:"list",label:"Fonts List",template:[[{type:"asset",name:"url",label:"File",value:""},{type:"title",name:"name",label:"Name",value:""}]],entry:{url:"",name:""},fields:t()}]]}]]}]})},v={meta:{document:a,generateId:s},clone:{definitions:C,getOriginal:c,getClone:u},manage:{markAsLayer:R,move:W,resize:G,remove:A,removeVolatile:U,add:_,addVolatile:Q,calcAndUpdateLayer:x},view:{calc:m,recalculate:N,draw:i,redraw:l,redrawDebounce:w(l)},policies:{isLayer:z,isClone:h},font:{load:X},setting:{set(e,n){let t=e.split(".");t.slice(-1)||t.pop(),j(t,n,a.settings)},get(e){let n=e.split(".");return n.slice(-1)||n.pop(),O(n,a.settings)??null},has:function(e){return!!(this.get(e)??!1)},retrieveSettingsDefinition:Y,setSettingsDefinition:q}},T=e=>!!(e&&typeof e=="object"&&!Array.isArray(e)),B=(e,...n)=>{if(!n.length)return e;let t=n.shift();if(T(e)&&T(t))for(let o in t){let r=t[o];T(r)?(e[o]||Object.assign(e,{[o]:{}}),B(e[o],r)):Object.assign(e,{[o]:r})}return B(e,...n)};return{module:v,internal:{init:async(e,n)=>{for(let r in n)v.setting.set(r,n[r]);let t=a;t.settings=B({},a.settings,n),t.base=e;let o=[];return(v.setting.get("core.fonts")??[]).forEach(r=>{o.push(v.font.load(r))}),await Promise.all(o),t.layout=await v.view.recalculate(t,t.base),v.view.redraw(t.layout),t}}}}export{J as default};
