var f={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"};var d=class{herald;constructor(e){this.herald=e}async loadModules(e,o){let r={},i={},n=new CustomEvent(f.MODULES,{detail:{registration:{}}});await this.herald.dispatch(n);let a=n.detail.registration;for(let t of e){if(!a[t])throw new Error("Module "+t+" is not present! Cannot instantiate the Antetype.");i[t]=a[t]}let s=this.orderModules(i);return await this.loadInGroups(r,o,s),r}loadInGroups(e,o,r){let i=[[]],n={},a=()=>{let t=i.slice(-1)[0];for(let l of t)n[l.name]=!0};for(let t of r){for(let l of t.requires??[])n[l]||(a(),i.push([]));i.slice(-1)[0].push(t)}let s=[];for(let t of i){let l=[];for(let p of t)l.push(new Promise(u=>{p.load(e,o).then(c=>{e[p.name]=c,u(c)})}));s.push(Promise.all(t))}return Promise.all(s)}orderModules(e){let o=[],r={},i=Object.keys(e).length*2;for(;!this.isObjectEmpty(e);){if(i--,i<0)throw console.warn("Not registered in load groups",e),new Error("Infinite dependency detected, stopping script...");e:for(let n in e){let a=e[n],s=a.requires??[];for(let t of s){if(!r[t]&&!e[t])throw new Error("Module "+n+" is requesting not present dependency: "+t);if(e[t])continue e}o.push({...a,name:n}),delete e[n],r[n]=!0}}return o}isObjectEmpty(e){for(let o in e)if(Object.prototype.hasOwnProperty.call(e,o))return!1;return!0}};export{d as default};
